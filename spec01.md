### **Cortex 自主运维体系技术规格书**

#### **1. 愿景与核心原则**

*   **愿景**: 构建一个去中心化、分级自治的智能运维网络。每个节点都是一个独立的Agent，但可以动态组合成强大的、具备集体智能的运维集群。
*   **核心原则**:
    *   **混合智能 (Hybrid Intelligence)**: 每个Agent都内置了执行单元(`probe`)和决策单元(`monitor`)。
    *   **动态层级与集群 (Dynamic Hierarchy & Clustering)**: 通过配置，节点可以形成指挥链。**一个上级节点的 `Monitor` 功能被设计为聚合与指挥中心，用于接收和管理其下辖的 *一个或多个* 下级Agent的上报。**
    *   **自主闭环 (Autonomous Loop)**: 在权责范围内，每个Agent都力求完成“发现-分析-决策-执行-验证”的完整闭环。
    *   **意图可追溯 (Intent-Driven)**: 所有重要操作都必须被封装为“意图”，由`Intent-Engine`进行全生命周期跟踪。

#### **2. 体系架构与项目构成**

*   **项目构成**: 由统一的GitHub项目 **`Cortex`** 构成。部署到任何节点上的都是同一份代码。
*   **核心单元**: **Cortex Agent**。
*   **架构模式**:
    *   **独立模式 (Standalone Mode)**: 未配置`upstream_monitor`的Agent。它是一个自治的根节点，直接向人类汇报。
    *   **集群模式 (Cluster Mode)**: 指定一个Agent作为上级`Monitor`，并将多个其他Agent的`upstream_monitor_url`指向它。这样就形成了一个“一主多从”的运维集群。这个结构可以嵌套，形成更复杂的网络。

#### **3. Cortex Agent: 统一组件定义**

每个Cortex Agent都是一个完整的应用，包含以下两个核心功能模块：

*   **1. 探测功能 (Probe Function)**
    *   **触发方式**: 由`cron`定时调用。
    *   **核心技术**: 启动无头LLM (`claude -p`) 执行本地巡检。
    *   **职责**:
        *   执行L1级自主修复。
        *   识别L2/L3级问题，并将其**提交给决策方**（可能是自身的`Monitor`，也可能是上级的`Monitor`）。

*   **2. 监控功能 (Monitor Function)**
    *   **触发方式**: 作为一个常驻的Web服务进程运行。
    *   **核心职责**:
        1.  **数据聚合中心**: 暴露API端点，持续接收并处理来自**多个源**的数据：
            *   **自身 `Probe` 功能**的上报。
            *   **所有已配置的下级 `Cortex Agent`** 的健康数据、事件日志和决策请求。
        2.  **集群指挥官**:
            *   当收到下级Agent的L2决策请求时，启动LLM实例进行风险分析，并将指令（批准/拒绝）准确地回传给**源Agent**。
            *   聚合所有下级节点的L3告警，进行去重和关联分析，然后统一向人类管理员发送通知。
        3.  **多层级信息展示 (Web UI)**:
            *   **全局仪表盘**: 当作为上级`Monitor`时，UI首页应是一个**集群视图**，汇总展示所有下级节点的关键状态（在线/离线、健康/告警），形成一目了然的全局态势。
            *   **下钻分析**: 用户可以从全局仪表盘点击任何一个下级节点，**下钻**到该节点的独立视图，查看其详细的健康数据、历史事件和操作日志。
            *   **自身状态**: UI中也应包含展示其**自身节点**健康状况的独立页面。

#### **4. 核心工作流：集群模式下的故障处理**

1.  **并行探测**: 集群内的`Node-A`、`Node-B`、`Node-C`上的`Probe`功能并行执行各自的巡检任务。
2.  **多源上报**:
    *   `Node-A`发现一个L2级问题，将其请求上报给上级`Monitor`。
    *   `Node-B`一切正常，按时上报了常规的健康心跳数据给上级`Monitor`。
    *   `Node-C`发现了一个严重的L3级未知错误，也将其告警上报给上级`Monitor`。
3.  **中央处理 (`Monitor`)**: 上级`Monitor`的Web服务同时接收到这三份不同的上报。
    *   它将`Node-B`的心跳数据更新到数据库和UI仪表盘。
    *   它为`Node-A`的L2请求启动一个决策LLM，分析后将“批准”指令发回给`Node-A`。
    *   它识别出`Node-C`的L3告警，立即通过Telegram向管理员发送告警，内容明确指出是`Node-C`发生严重问题。
4.  **状态更新与展示 (UI)**: 管理员打开上级`Monitor`的Web UI，会看到：
    *   全局仪表盘上，`Node-A`和`Node-C`的状态已变为红色告警。
    *   点击`Node-A`，可以看到它刚刚完成了一次“被批准的”修复操作。
    *   点击`Node-C`，可以看到触发L3告警的详细日志。

---
这个最终版本明确了`Monitor`作为**集群大脑**的核心定位，使其不仅仅是一个被动的决策者，更是一个主动的**数据聚合器**和**舰队指挥官**。这使得整个Cortex体系的架构设计更加清晰、强大和符合实际应用场景。