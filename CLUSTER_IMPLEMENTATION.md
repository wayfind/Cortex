# Cortex é›†ç¾¤æ¨¡å¼å®ç°æ€»ç»“

## ğŸ“… å®ç°æ—¶é—´
2025-11-16

## ğŸ¯ å®ç°ç›®æ ‡
å®ç°å®Œæ•´çš„ Cortex é›†ç¾¤æ¨¡å¼ï¼Œæ”¯æŒå¤šå±‚çº§èŠ‚ç‚¹ååŒå†³ç­–å’Œç®¡ç†ã€‚

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. èŠ‚ç‚¹æ³¨å†Œå’Œå±‚çº§ç®¡ç†
- âœ… æ•°æ®åº“æ”¯æŒï¼š`Agent` æ¨¡å‹æ·»åŠ  `parent_id` å­—æ®µ
- âœ… API ç«¯ç‚¹ï¼š`POST /api/v1/agents` èŠ‚ç‚¹æ³¨å†Œ
- âœ… Token éªŒè¯ï¼š`registration_token` é˜²æ­¢æœªæˆæƒæ³¨å†Œ
- âœ… å±‚çº§éªŒè¯ï¼šçˆ¶èŠ‚ç‚¹å­˜åœ¨æ€§æ£€æŸ¥
- âœ… æ”¯æŒæ›´æ–°ï¼šé‡æ–°æ³¨å†Œæ›´æ–°èŠ‚ç‚¹ä¿¡æ¯

### 2. é›†ç¾¤æ‹“æ‰‘ç®¡ç†
- âœ… æ‹“æ‰‘æŸ¥è¯¢ï¼š`GET /api/v1/cluster/topology`
- âœ… é€’å½’è®¡ç®—ï¼šè‡ªåŠ¨è®¡ç®—èŠ‚ç‚¹å±‚çº§ï¼ˆL0/L1/L2/...ï¼‰
- âœ… å¾ªç¯æ£€æµ‹ï¼šé˜²æ­¢æ‹“æ‰‘ç»“æ„ä¸­çš„å¾ªç¯ä¾èµ–
- âœ… å±‚çº§åˆ†ç»„ï¼šæŒ‰ L0ã€L1ã€L2 ç­‰åˆ†ç»„å±•ç¤º
- âœ… å®Œæ•´ä¿¡æ¯ï¼šåŒ…å«èŠ‚ç‚¹çŠ¶æ€ã€å¥åº·çŠ¶æ€ã€å¿ƒè·³æ—¶é—´

### 3. å¿ƒè·³æ£€æµ‹æœºåˆ¶
- âœ… å¿ƒè·³ç«¯ç‚¹ï¼š`POST /api/v1/agents/{agent_id}/heartbeat`
- âœ… åå°æœåŠ¡ï¼š`HeartbeatChecker` è‡ªåŠ¨æ£€æµ‹
- âœ… è¶…æ—¶å¤„ç†ï¼š5 åˆ†é’Ÿæ— å¿ƒè·³æ ‡è®°ä¸º offline
- âœ… æ£€æŸ¥é¢‘ç‡ï¼šæ¯ 60 ç§’æ‰§è¡Œä¸€æ¬¡
- âœ… ç”Ÿå‘½å‘¨æœŸï¼šé›†æˆåˆ°åº”ç”¨å¯åŠ¨/å…³é—­

### 4. è·¨èŠ‚ç‚¹ L2 å†³ç­–
- âœ… å†³ç­–ç«¯ç‚¹ï¼š`POST /api/v1/decisions/request`
- âœ… ä¸Šçº§è½¬å‘ï¼š`UpstreamForwarder` è‡ªåŠ¨è½¬å‘
- âœ… æ¨¡å¼æ£€æµ‹ï¼šè‡ªåŠ¨è¯†åˆ«é›†ç¾¤/ç‹¬ç«‹æ¨¡å¼
- âœ… å®¹é”™å›é€€ï¼šä¸Šçº§å¤±è´¥æ—¶æœ¬åœ°å†³ç­–
- âœ… å†³ç­–å­˜å‚¨ï¼šä¸Šçº§å†³ç­–åŒæ­¥åˆ°æœ¬åœ°

### 5. å†³ç­–æŒ‡ä»¤å›ä¼ 
- âœ… åé¦ˆç«¯ç‚¹ï¼š`POST /api/v1/decisions/{id}/feedback`
- âœ… æ‰§è¡Œç»“æœï¼šè®°å½•æ‰§è¡Œæ—¶é—´å’Œç»“æœ
- âœ… çŠ¶æ€è·Ÿè¸ªï¼šå®Œæ•´çš„å†³ç­–ç”Ÿå‘½å‘¨æœŸ

## ğŸ“Š æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•
- âœ… èŠ‚ç‚¹ç®¡ç†ï¼š3 ä¸ªæµ‹è¯•ï¼ˆæ ¹èŠ‚ç‚¹ã€å­èŠ‚ç‚¹ã€ä¸‰å±‚å±‚çº§ï¼‰
- âœ… å¿ƒè·³æ£€æµ‹ï¼š2 ä¸ªæµ‹è¯•ï¼ˆçŠ¶æ€æ›´æ–°ã€å¥åº·çŠ¶æ€ï¼‰
- âœ… ä¸Šçº§è½¬å‘ï¼š3 ä¸ªæµ‹è¯•ï¼ˆæˆåŠŸã€å¤±è´¥ã€éœ€æ±‚æ£€æŸ¥ï¼‰
- âœ… å†³ç­–åé¦ˆï¼š2 ä¸ªæµ‹è¯•ï¼ˆæœ¬åœ°å­˜å‚¨ã€æ‰§è¡Œç»“æœï¼‰
- âœ… æ‹“æ‰‘è®¡ç®—ï¼š1 ä¸ªæµ‹è¯•ï¼ˆå±‚çº§è®¡ç®—ï¼‰
- âœ… ç«¯åˆ°ç«¯ï¼š2 ä¸ªæµ‹è¯•ï¼ˆå®Œæ•´å·¥ä½œæµï¼‰

### é›†æˆæµ‹è¯•
- âœ… Monitor é›†æˆï¼š20 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
- âœ… é…ç½®åŠ è½½ï¼š15 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
- âœ… æ•°æ®åº“æ¨¡å‹ï¼š5 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡

### æµ‹è¯•ç»Ÿè®¡
- **æ€»è®¡**ï¼š33 ä¸ªé›†ç¾¤ç›¸å…³æµ‹è¯•
- **é€šè¿‡ç‡**ï¼š100%
- **è¦†ç›–ç‡**ï¼šUpstreamForwarder 93%

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### é›†ç¾¤æ¨¡å¼å·¥ä½œæµ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Probe (L1 è‡ªä¿®) â†’ Monitor (å­èŠ‚ç‚¹)   â”‚
â”‚           â†“              â†“           â”‚
â”‚     L2 é—®é¢˜æ£€æµ‹   UpstreamForwarder   â”‚
â”‚                         â†“            â”‚
â”‚           POST /decisions/request    â”‚
â”‚                         â†“            â”‚
â”‚         Monitor (ä¸Šçº§) + LLM å†³ç­–     â”‚
â”‚                         â†“            â”‚
â”‚            è¿”å›å†³ç­– (æ‰¹å‡†/æ‹’ç»)         â”‚
â”‚                         â†“            â”‚
â”‚         å­˜å‚¨åˆ°æœ¬åœ° + æ‰§è¡Œ + åé¦ˆ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®åº“æ¨¡å‹
```python
class Agent(Base):
    id: str                          # Agent ID
    name: str                        # åç§°
    parent_id: Optional[str]         # çˆ¶èŠ‚ç‚¹ IDï¼ˆé›†ç¾¤æ¨¡å¼ï¼‰
    upstream_monitor_url: Optional[str]  # ä¸Šçº§ Monitor URL
    status: str                      # online/offline
    health_status: str               # healthy/warning/critical
    last_heartbeat: Optional[datetime]   # æœ€åå¿ƒè·³æ—¶é—´
```

## ğŸ“ æ–°å¢æ–‡ä»¶

### æœåŠ¡å±‚
- `cortex/monitor/services/heartbeat_checker.py` (95è¡Œ)
- `cortex/monitor/services/upstream_forwarder.py` (75è¡Œ)

### æµ‹è¯•æ–‡ä»¶
- `tests/test_cluster_integration.py` (500è¡Œ)
- `tests/test_heartbeat_manual.py` (120è¡Œ)
- `tests/test_cluster_manual.py` (å·²å­˜åœ¨ï¼Œå¢å¼º)

## ğŸ”§ ä¿®æ”¹æ–‡ä»¶

### æ•°æ®åº“
- `cortex/monitor/database.py`ï¼šæ·»åŠ  `parent_id` å­—æ®µ

### è·¯ç”±
- `cortex/monitor/routers/cluster.py`ï¼š
  - å¢å¼ºèŠ‚ç‚¹æ³¨å†Œ API
  - æ·»åŠ å¿ƒè·³ç«¯ç‚¹
  - æ·»åŠ æ‹“æ‰‘æŸ¥è¯¢
- `cortex/monitor/routers/decisions.py`ï¼š
  - æ·»åŠ å†³ç­–è¯·æ±‚ç«¯ç‚¹
- `cortex/monitor/routers/reports.py`ï¼š
  - é›†ç¾¤æ¨¡å¼è‡ªåŠ¨è½¬å‘é€»è¾‘

### åº”ç”¨
- `cortex/monitor/app.py`ï¼šé›†æˆå¿ƒè·³æ£€æµ‹å™¨
- `cortex/monitor/services/__init__.py`ï¼šå¯¼å‡ºæ–°æœåŠ¡

## ğŸš€ Git æäº¤å†å²

1. **b3dc0e6**: é›†ç¾¤æ¨¡å¼åŸºç¡€æ¶æ„
   - èŠ‚ç‚¹æ³¨å†Œ + æ‹“æ‰‘ç®¡ç†
   
2. **e41a2b4**: å¿ƒè·³æ£€æµ‹æœºåˆ¶
   - 5 åˆ†é’Ÿè¶…æ—¶ + åå°æ£€æŸ¥
   
3. **964cb4f**: è·¨èŠ‚ç‚¹ L2 å†³ç­–
   - ä¸Šçº§è½¬å‘ + å®¹é”™å›é€€
   
4. **3881eee**: é›†æˆæµ‹è¯•
   - 13 ä¸ªæµ‹è¯• 100% é€šè¿‡

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç‹¬ç«‹æ¨¡å¼
```yaml
agent:
  id: "standalone-monitor"
  name: "Standalone Monitor"
  mode: "standalone"

# ä¸é…ç½® upstream_monitor_urlï¼Œè‡ªåŠ¨ä½¿ç”¨ç‹¬ç«‹æ¨¡å¼
```

### é›†ç¾¤æ¨¡å¼ - å­èŠ‚ç‚¹
```yaml
agent:
  id: "child-monitor"
  name: "Child Monitor"
  mode: "cluster"
  upstream_monitor_url: "http://parent:8000"
  
monitor:
  registration_token: "your-secret-token"
```

### æ³¨å†ŒèŠ‚ç‚¹
```bash
curl -X POST http://parent:8000/api/v1/agents \
  -H "Content-Type: application/json" \
  -d '{
    "agent_id": "child-001",
    "name": "Child Node 001",
    "api_key": "child-key",
    "registration_token": "your-secret-token",
    "parent_id": "parent-monitor",
    "upstream_monitor_url": "http://parent:8000"
  }'
```

### å‘é€å¿ƒè·³
```bash
curl -X POST http://localhost:8000/api/v1/agents/child-001/heartbeat \
  -H "Content-Type: application/json" \
  -d '{"health_status": "healthy"}'
```

### æŸ¥è¯¢æ‹“æ‰‘
```bash
curl http://localhost:8000/api/v1/cluster/topology
```

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰
- [ ] éƒ¨ç½²æµ‹è¯•ç¯å¢ƒéªŒè¯å®é™…é›†ç¾¤åœºæ™¯
- [ ] ç¼–å†™ç”¨æˆ·æ–‡æ¡£å’Œéƒ¨ç½²æŒ‡å—
- [ ] æ·»åŠ é›†ç¾¤å¥åº·ç›‘æ§ä»ªè¡¨ç›˜

### ä¸­æœŸï¼ˆ1-2æœˆï¼‰
- [ ] å®ç° Web UI å±•ç¤ºé›†ç¾¤æ‹“æ‰‘å›¾
- [ ] æ·»åŠ èŠ‚ç‚¹é—´è´Ÿè½½å‡è¡¡
- [ ] å®ç°é›†ç¾¤é…ç½®çƒ­æ›´æ–°

### é•¿æœŸï¼ˆ3-6æœˆï¼‰
- [ ] æ”¯æŒè·¨åŒºåŸŸé›†ç¾¤
- [ ] å®ç°é›†ç¾¤è‡ªåŠ¨æ•…éšœè½¬ç§»
- [ ] æ·»åŠ é›†ç¾¤æ€§èƒ½ä¼˜åŒ–

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

1. **Token ä¿æŠ¤**ï¼š`registration_token` å¿…é¡»ä¿å¯†
2. **API è®¤è¯**ï¼šç”Ÿäº§ç¯å¢ƒå¯ç”¨ API Key éªŒè¯
3. **ç½‘ç»œéš”ç¦»**ï¼šå»ºè®®ä½¿ç”¨ VPN æˆ–å†…ç½‘é€šä¿¡
4. **è®¿é—®æ§åˆ¶**ï¼šé™åˆ¶èŠ‚ç‚¹æ³¨å†Œå’Œå¿ƒè·³ç«¯ç‚¹çš„è®¿é—®

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [CLAUDE.md](./CLAUDE.md) - é¡¹ç›®æ¶æ„è¯´æ˜
- [spec01.md](./docs/spec01.md) - ç³»ç»Ÿè§„æ ¼è¯´æ˜
- [tests/test_cluster_integration.py](./tests/test_cluster_integration.py) - æµ‹è¯•ç”¨ä¾‹

## ğŸ‘¥ è´¡çŒ®è€…

- Claude Code - å®Œæ•´å®ç°
- Intent-Engine - ä»»åŠ¡è·Ÿè¸ª

---

**å®ç°å®Œæˆæ—¶é—´**ï¼š2025-11-16  
**æµ‹è¯•é€šè¿‡ç‡**ï¼š100% (33/33)  
**ä»£ç è¡Œæ•°**ï¼šçº¦ 800 è¡Œï¼ˆæ–°å¢ï¼‰  
**æ–‡æ¡£å®Œæ•´æ€§**ï¼šâœ… å®Œæ•´
