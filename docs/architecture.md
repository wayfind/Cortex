# Cortex 系统架构文档

## 1. 系统概述

### 1.1 项目愿景

Cortex 致力于构建一个去中心化、分级自治的智能运维网络。每个节点都是一个独立的 Agent，但可以动态组合成强大的、具备集体智能的运维集群。

### 1.2 核心设计原则

#### 1.2.1 混合智能 (Hybrid Intelligence)
每个 Agent 都内置了执行单元（`Probe`）和决策单元（`Monitor`）。这种设计使得每个节点既可以独立工作，也可以作为集群的一部分协同运作。

#### 1.2.2 动态层级与集群 (Dynamic Hierarchy & Clustering)
通过配置，节点可以形成指挥链。一个上级节点的 `Monitor` 功能被设计为聚合与指挥中心，用于接收和管理其下辖的一个或多个下级 Agent 的上报。

#### 1.2.3 自主闭环 (Autonomous Loop)
在权责范围内，每个 Agent 都力求完成"发现-分析-决策-执行-验证"的完整闭环，实现真正的自主运维。

#### 1.2.4 意图可追溯 (Intent-Driven)
所有重要操作都必须被封装为"意图"，由 `Intent-Engine` 进行全生命周期跟踪，确保每个决策和操作都有完整的审计轨迹。

## 2. 整体系统架构

### 2.1 单一代码库设计

Cortex 采用单一代码库设计理念。所有节点都从同一个 GitHub 项目部署，通过配置文件决定其运行模式和角色。

```
┌─────────────────────────────────────┐
│      Cortex 代码库 (GitHub)          │
│  ┌────────────┐   ┌───────────────┐ │
│  │   Probe    │   │    Monitor    │ │
│  │  (执行单元) │   │   (决策单元)   │ │
│  └────────────┘   └───────────────┘ │
│  ┌────────────────────────────────┐ │
│  │      Intent-Engine             │ │
│  └────────────────────────────────┘ │
└─────────────────────────────────────┘
           │
           ├──► 部署到节点 A（独立模式）
           ├──► 部署到节点 B（集群主节点）
           └──► 部署到节点 C、D、E（集群从节点）
```

### 2.2 独立模式架构

在独立模式下，Cortex Agent 作为自治的根节点运行，直接向人类管理员汇报。

```
┌─────────────────────────────────────────┐
│         Cortex Agent (独立模式)          │
│                                         │
│  ┌──────────────────────────────────┐  │
│  │  Probe (Cron 定时触发)            │  │
│  │  ┌────────────┐                   │  │
│  │  │ LLM 巡检   │                   │  │
│  │  │ (claude -p)│                   │  │
│  │  └─────┬──────┘                   │  │
│  │        │ 发现问题                  │  │
│  │        ├──► L1: 自主修复           │  │
│  │        └──► L2/L3: 上报           │  │
│  └────────┬─────────────────────────┘  │
│           │                             │
│           ▼ 上报                        │
│  ┌──────────────────────────────────┐  │
│  │  Monitor (Web 服务常驻)           │  │
│  │  ┌────────────┐                   │  │
│  │  │ 数据聚合   │                   │  │
│  │  ├────────────┤                   │  │
│  │  │ L2 决策    │ ◄─── LLM 分析     │  │
│  │  ├────────────┤                   │  │
│  │  │ L3 告警    │ ───► Telegram     │  │
│  │  ├────────────┤                   │  │
│  │  │ Web UI     │ ◄─── 人类查看     │  │
│  │  └────────────┘                   │  │
│  └──────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

**配置特征**：
- `upstream_monitor`: 未配置或为空
- `mode`: standalone

### 2.3 集群模式架构（单层）

在集群模式下，形成"一主多从"的运维集群。上级 Monitor 充当集群大脑，聚合并指挥多个下级节点。

```
┌────────────────────────────────────────────────────────┐
│              上级 Cortex Agent (集群主节点)               │
│                                                        │
│  ┌───────────────────────────────────────────────┐    │
│  │  Monitor (集群指挥中心)                         │    │
│  │  ┌─────────────────────────────────────────┐  │    │
│  │  │  数据聚合中心                             │  │    │
│  │  │  ├─ 接收自身 Probe 上报                   │  │    │
│  │  │  ├─ 接收 Node-A 上报                     │  │    │
│  │  │  ├─ 接收 Node-B 上报                     │  │    │
│  │  │  └─ 接收 Node-C 上报                     │  │    │
│  │  └─────────────────────────────────────────┘  │    │
│  │  ┌─────────────────────────────────────────┐  │    │
│  │  │  集群指挥官                               │  │    │
│  │  │  ├─ L2 决策请求处理 (启动 LLM)           │  │    │
│  │  │  ├─ 指令回传 (批准/拒绝)                 │  │    │
│  │  │  └─ L3 告警聚合与通知                    │  │    │
│  │  └─────────────────────────────────────────┘  │    │
│  │  ┌─────────────────────────────────────────┐  │    │
│  │  │  Web UI (集群视图)                        │  │    │
│  │  │  ├─ 全局仪表盘 (显示所有下级节点)         │  │    │
│  │  │  ├─ 下钻分析 (单个节点详情)               │  │    │
│  │  │  └─ 自身状态页                           │  │    │
│  │  └─────────────────────────────────────────┘  │    │
│  └───────────────────────────────────────────────┘    │
└────────────────┬───────────────┬───────────────┬───────┘
                 │               │               │
        ┌────────▼──────┐ ┌─────▼──────┐ ┌─────▼──────┐
        │   Node-A      │ │  Node-B    │ │  Node-C    │
        │  (下级 Agent) │ │ (下级 Agent)│ │ (下级 Agent)│
        │               │ │            │ │            │
        │ Probe + Monitor│ │Probe + Monitor│ │Probe + Monitor│
        │               │ │            │ │            │
        │ ▲ 上报        │ │ ▲ 上报     │ │ ▲ 上报     │
        │ ▼ 指令        │ │ ▼ 指令     │ │ ▼ 指令     │
        └───────────────┘ └────────────┘ └────────────┘
```

**配置特征**：
- 上级节点：`upstream_monitor` 未配置，`mode`: cluster
- 下级节点：`upstream_monitor_url`: "https://上级节点地址"

### 2.4 多层嵌套集群架构

Cortex 支持集群的嵌套部署，形成多层级的运维网络。

```
                  ┌──────────────┐
                  │  根节点 (L0)  │
                  │   Monitor    │
                  └──────┬───────┘
                         │
        ┌────────────────┼────────────────┐
        │                │                │
   ┌────▼────┐      ┌────▼────┐     ┌────▼────┐
   │区域A (L1)│      │区域B (L1)│     │区域C (L1)│
   │ Monitor │      │ Monitor │     │ Monitor │
   └────┬────┘      └────┬────┘     └────┬────┘
        │                │                │
   ┌────┼────┐      ┌────┼────┐      ┌───┴────┐
   │    │    │      │    │    │      │        │
 ┌─▼─┐┌─▼─┐┌─▼─┐  ┌─▼─┐┌─▼─┐┌─▼─┐  ┌─▼─┐   ┌─▼─┐
 │N-1││N-2││N-3│  │N-4││N-5││N-6│  │N-7│   │N-8│
 └───┘└───┘└───┘  └───┘└───┘└───┘  └───┘   └───┘
  (L2)  (L2) (L2)   (L2) (L2) (L2)   (L2)    (L2)
```

**层级说明**：
- **L0（根节点）**：全局指挥中心，直接向人类汇报
- **L1（区域节点）**：区域指挥中心，管理本区域的叶子节点
- **L2（叶子节点）**：实际执行运维任务的节点

## 3. Cortex Agent 双核心模块设计

### 3.1 Probe 模块（探测功能）

#### 3.1.1 定位与角色
- **定位**：执行单元，现场操作员
- **运行模式**：Cron 定时触发（非常驻进程）
- **核心技术**：无头 LLM (`claude -p`)

#### 3.1.2 工作流程

```
┌─────────────────────────────────────────────────────┐
│  Probe 执行流程                                      │
│                                                     │
│  1. Cron 触发                                        │
│     │                                               │
│     ▼                                               │
│  2. 启动 LLM 巡检 (claude -p)                        │
│     │                                               │
│     ├──► 系统健康检查 (CPU/内存/磁盘)                 │
│     ├──► 服务状态检查 (进程/端口)                     │
│     ├──► 日志异常扫描                                │
│     └──► 网络连通性测试                              │
│     │                                               │
│     ▼                                               │
│  3. 问题分级识别                                      │
│     │                                               │
│     ├──► L1: 简单问题 (磁盘满、服务未启动等)          │
│     │     └──► 自主修复                              │
│     │         └──► 验证修复结果                      │
│     │                                               │
│     ├──► L2: 需决策问题 (需重启关键服务、配置变更等)   │
│     │     └──► 上报给 Monitor，请求决策               │
│     │                                               │
│     └──► L3: 严重/未知问题 (系统崩溃、数据异常等)     │
│           └──► 上报给 Monitor，触发告警              │
│     │                                               │
│     ▼                                               │
│  4. 生成上报数据                                      │
│     │                                               │
│     ├──► 健康心跳数据                                │
│     ├──► 问题报告 (含严重级别)                        │
│     └──► 修复操作日志                                │
│     │                                               │
│     ▼                                               │
│  5. HTTP POST 到 Monitor                             │
│     │                                               │
│     └──► 等待 L2 决策响应 (如有)                     │
│                                                     │
└─────────────────────────────────────────────────────┘
```

#### 3.1.3 数据输出

**上报数据结构**：
```json
{
  "agent_id": "node-001",
  "timestamp": "2025-11-16T10:00:00Z",
  "status": "healthy|warning|critical",
  "metrics": {
    "cpu_percent": 45.2,
    "memory_percent": 62.1,
    "disk_percent": 38.5,
    "load_average": [1.2, 1.5, 1.8]
  },
  "issues": [
    {
      "level": "L2",
      "type": "service_down",
      "description": "nginx service stopped unexpectedly",
      "proposed_fix": "systemctl restart nginx",
      "risk_assessment": "中风险：可能影响 Web 服务可用性"
    }
  ],
  "actions_taken": [
    {
      "level": "L1",
      "action": "cleared /tmp directory (freed 2GB)",
      "result": "success",
      "timestamp": "2025-11-16T09:58:00Z"
    }
  ]
}
```

### 3.2 Monitor 模块（监控功能）

#### 3.2.1 定位与角色
- **定位**：决策单元，集群大脑
- **运行模式**：常驻 Web 服务进程
- **核心技术**：FastAPI + SQLite + LLM

#### 3.2.2 三大核心职责

##### 职责一：数据聚合中心

```
┌──────────────────────────────────────────┐
│  数据聚合中心                             │
│                                          │
│  输入源：                                 │
│  ┌────────────────────────────────────┐ │
│  │ 1. 自身 Probe 上报 (本地)           │ │
│  │ 2. 下级 Agent-A 上报 (HTTP)        │ │
│  │ 3. 下级 Agent-B 上报 (HTTP)        │ │
│  │ 4. 下级 Agent-C 上报 (HTTP)        │ │
│  │ ...                                │ │
│  └────────────────────────────────────┘ │
│            │                             │
│            ▼                             │
│  ┌────────────────────────────────────┐ │
│  │  统一数据模型                        │ │
│  │  ├─ 节点元数据                      │ │
│  │  ├─ 实时指标                        │ │
│  │  ├─ 问题报告                        │ │
│  │  └─ 操作日志                        │ │
│  └────────────────────────────────────┘ │
│            │                             │
│            ▼                             │
│  ┌────────────────────────────────────┐ │
│  │  SQLite 数据库持久化                 │ │
│  └────────────────────────────────────┘ │
└──────────────────────────────────────────┘
```

##### 职责二：集群指挥官

```
┌──────────────────────────────────────────┐
│  集群指挥官                               │
│                                          │
│  L2 决策流程：                            │
│  ┌────────────────────────────────────┐ │
│  │ 1. 接收下级 Agent 的 L2 决策请求    │ │
│  └────────────┬───────────────────────┘ │
│               │                          │
│               ▼                          │
│  ┌────────────────────────────────────┐ │
│  │ 2. 启动 LLM 实例进行风险分析        │ │
│  │    - 分析操作风险                   │ │
│  │    - 评估影响范围                   │ │
│  │    - 考虑当前系统状态               │ │
│  └────────────┬───────────────────────┘ │
│               │                          │
│               ▼                          │
│  ┌────────────────────────────────────┐ │
│  │ 3. 生成决策 (批准/拒绝)             │ │
│  └────────────┬───────────────────────┘ │
│               │                          │
│               ▼                          │
│  ┌────────────────────────────────────┐ │
│  │ 4. 将指令回传给源 Agent             │ │
│  └────────────────────────────────────┘ │
│                                          │
│  L3 告警处理：                            │
│  ┌────────────────────────────────────┐ │
│  │ 1. 接收多个节点的 L3 告警           │ │
│  └────────────┬───────────────────────┘ │
│               │                          │
│               ▼                          │
│  ┌────────────────────────────────────┐ │
│  │ 2. 去重与关联分析                   │ │
│  │    - 识别重复告警                   │ │
│  │    - 发现关联问题                   │ │
│  └────────────┬───────────────────────┘ │
│               │                          │
│               ▼                          │
│  ┌────────────────────────────────────┐ │
│  │ 3. 生成统一告警报告                 │ │
│  └────────────┬───────────────────────┘ │
│               │                          │
│               ▼                          │
│  ┌────────────────────────────────────┐ │
│  │ 4. 通过 Telegram 通知人类管理员     │ │
│  └────────────────────────────────────┘ │
└──────────────────────────────────────────┘
```

##### 职责三：多层级信息展示 (Web UI)

```
┌──────────────────────────────────────────┐
│  Web UI 架构                              │
│                                          │
│  ┌────────────────────────────────────┐ │
│  │  全局仪表盘 (首页 - 集群视图)       │ │
│  │  ┌──────────────────────────────┐  │ │
│  │  │  节点状态矩阵                 │  │ │
│  │  │  ┌────┬────┬────┬────┐       │  │ │
│  │  │  │ ✓  │ ✓  │ ⚠  │ ✗  │       │  │ │
│  │  │  │N-1 │N-2 │N-3 │N-4 │       │  │ │
│  │  │  └────┴────┴────┴────┘       │  │ │
│  │  │  ✓ 正常  ⚠ 警告  ✗ 故障      │  │ │
│  │  └──────────────────────────────┘  │ │
│  │  ┌──────────────────────────────┐  │ │
│  │  │  实时告警流                   │  │ │
│  │  │  🔴 Node-3: 磁盘空间不足      │  │ │
│  │  │  🔴 Node-4: 服务离线          │  │ │
│  │  └──────────────────────────────┘  │ │
│  │  ┌──────────────────────────────┐  │ │
│  │  │  集群关键指标汇总              │  │ │
│  │  │  平均 CPU: 45%                │  │ │
│  │  │  平均内存: 62%                │  │ │
│  │  │  在线节点: 12/15              │  │ │
│  │  └──────────────────────────────┘  │ │
│  └────────────────────────────────────┘ │
│            │ 点击节点                    │
│            ▼                            │
│  ┌────────────────────────────────────┐ │
│  │  节点详情页 (下钻分析)              │ │
│  │  ┌──────────────────────────────┐  │ │
│  │  │  节点: Node-3                 │  │ │
│  │  │  状态: ⚠ 警告                 │  │ │
│  │  └──────────────────────────────┘  │ │
│  │  ┌──────────────────────────────┐  │ │
│  │  │  健康指标图表 (时间序列)      │  │ │
│  │  │  CPU ─────────▲─────          │  │ │
│  │  │  内存 ────▲────────           │  │ │
│  │  │  磁盘 ▲▲▲▲▲▲▲▲▲▲ (95%)      │  │ │
│  │  └──────────────────────────────┘  │ │
│  │  ┌──────────────────────────────┐  │ │
│  │  │  历史事件时间线               │  │ │
│  │  │  10:30 - L1 自动清理 /tmp     │  │ │
│  │  │  10:15 - 磁盘空间告警         │  │ │
│  │  │  09:00 - 正常巡检完成         │  │ │
│  │  └──────────────────────────────┘  │ │
│  │  ┌──────────────────────────────┐  │ │
│  │  │  操作日志列表                 │  │ │
│  │  └──────────────────────────────┘  │ │
│  └────────────────────────────────────┘ │
│                                          │
│  ┌────────────────────────────────────┐ │
│  │  告警中心                           │ │
│  │  (可筛选、排序、搜索)                │ │
│  └────────────────────────────────────┘ │
│                                          │
│  ┌────────────────────────────────────┐ │
│  │  自身状态页                         │ │
│  │  (当前 Monitor 节点的健康状况)       │ │
│  └────────────────────────────────────┘ │
└──────────────────────────────────────────┘
```

## 4. 独立模式 vs 集群模式架构差异

| 特性 | 独立模式 | 集群模式 (上级) | 集群模式 (下级) |
|------|---------|----------------|----------------|
| **配置** | | | |
| `upstream_monitor` | 未配置 | 未配置 | 配置指向上级 URL |
| `mode` | standalone | cluster | cluster |
| **Probe** | | | |
| 上报目标 | 自身 Monitor | 自身 Monitor | 上级 Monitor |
| L1 修复 | 自主执行 | 自主执行 | 自主执行 |
| L2 决策 | 本地 Monitor | 本地 Monitor | 上级 Monitor |
| **Monitor** | | | |
| 聚合对象 | 仅自身 | 自身 + 多个下级 | 自身 + 可能的下级 |
| 决策权限 | L2 自主决策 | L2 自主决策 (下级请求) | 需上级批准 (自身请求) |
| L3 告警目标 | 人类 (Telegram) | 人类 (Telegram) | 上级 Monitor |
| **Web UI** | | | |
| 首页视图 | 自身状态 | 集群仪表盘 | 集群仪表盘 (下级) |
| 节点管理 | N/A | 显示所有下级 | 显示所有下级 (如有) |
| **人类交互** | | | |
| 汇报方式 | 直接汇报 | 直接汇报 | 通过上级 Monitor |
| Web UI 访问 | 直接访问 | 直接访问 | 可访问 (查看下级) |

## 5. 数据流与控制流

### 5.1 数据流 (集群模式)

```
┌──────────────┐
│  下级 Node-A  │
│              │
│  ┌────────┐  │     HTTP POST
│  │ Probe  ├──┼─────────────┐
│  └────────┘  │             │
└──────────────┘             │
                             │
┌──────────────┐             │
│  下级 Node-B  │             │
│              │             │
│  ┌────────┐  │     HTTP POST
│  │ Probe  ├──┼─────────────┤
│  └────────┘  │             │
└──────────────┘             │
                             ▼
┌──────────────────────────────────────┐
│  上级 Monitor                         │
│                                      │
│  ┌────────────────────────────────┐ │
│  │  API 端点                       │ │
│  │  /api/v1/reports               │ │
│  │  /api/v1/heartbeat             │ │
│  └───────────┬────────────────────┘ │
│              │                       │
│              ▼                       │
│  ┌────────────────────────────────┐ │
│  │  数据验证与解析                 │ │
│  └───────────┬────────────────────┘ │
│              │                       │
│              ▼                       │
│  ┌────────────────────────────────┐ │
│  │  SQLite 数据库存储              │ │
│  │  - agents 表                   │ │
│  │  - reports 表                  │ │
│  │  - alerts 表                   │ │
│  └───────────┬────────────────────┘ │
│              │                       │
│              ▼                       │
│  ┌────────────────────────────────┐ │
│  │  Web UI 查询展示                │ │
│  └────────────────────────────────┘ │
└──────────────────────────────────────┘
```

### 5.2 控制流 (L2 决策请求)

```
┌──────────────┐
│  下级 Node-A  │
│              │
│  ┌────────┐  │
│  │ Probe  │  │  发现 L2 问题：nginx 服务停止
│  │        │  │  提议操作：systemctl restart nginx
│  └────┬───┘  │
│       │      │
│       └──────┼─── HTTP POST /api/v1/decisions/request
└──────────────┘     {
                       "agent_id": "node-a",
                       "issue": {...},
                       "proposed_action": "systemctl restart nginx"
                     }
                       │
                       ▼
┌────────────────────────────────────────────────┐
│  上级 Monitor                                   │
│                                                │
│  ┌──────────────────────────────────────────┐ │
│  │  1. 接收决策请求                          │ │
│  └────────────┬─────────────────────────────┘ │
│               │                                │
│               ▼                                │
│  ┌──────────────────────────────────────────┐ │
│  │  2. 启动 LLM 风险分析                     │ │
│  │     Prompt:                               │ │
│  │     "节点 node-a 的 nginx 服务停止，       │ │
│  │      提议重启服务。请分析风险并决策。"     │ │
│  │                                           │ │
│  │     LLM 响应:                              │ │
│  │     "风险评估：低风险。nginx 重启通常安全， │ │
│  │      建议批准。"                           │ │
│  └────────────┬─────────────────────────────┘ │
│               │                                │
│               ▼                                │
│  ┌──────────────────────────────────────────┐ │
│  │  3. 生成决策记录                          │ │
│  │     decision: "approved"                  │ │
│  │     reason: "低风险，批准执行"             │ │
│  └────────────┬─────────────────────────────┘ │
│               │                                │
│               ▼                                │
│  ┌──────────────────────────────────────────┐ │
│  │  4. 存储到 decisions 表                   │ │
│  └────────────┬─────────────────────────────┘ │
│               │                                │
│               └─── HTTP 200 Response           │
└────────────────────│───────────────────────────┘
                     │ {
                     │   "decision_id": 123,
                     │   "status": "approved",
                     │   "reason": "低风险，批准执行"
                     │ }
                     ▼
┌──────────────────────────────────────┐
│  下级 Node-A                          │
│                                      │
│  ┌────────────────────────────────┐ │
│  │  5. 接收批准指令                │ │
│  └───────────┬────────────────────┘ │
│              │                       │
│              ▼                       │
│  ┌────────────────────────────────┐ │
│  │  6. 执行操作                    │ │
│  │     systemctl restart nginx    │ │
│  └───────────┬────────────────────┘ │
│              │                       │
│              ▼                       │
│  ┌────────────────────────────────┐ │
│  │  7. 验证结果并上报              │ │
│  │     "nginx 服务已成功重启"      │ │
│  └────────────────────────────────┘ │
└──────────────────────────────────────┘
```

### 5.3 告警流 (L3 严重问题)

```
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  Node-A      │    │  Node-B      │    │  Node-C      │
│              │    │              │    │              │
│  发现 L3:    │    │  正常运行    │    │  发现 L3:    │
│  数据库崩溃   │    │              │    │  磁盘故障    │
└──────┬───────┘    └──────┬───────┘    └──────┬───────┘
       │ L3 告警           │ 心跳              │ L3 告警
       │                   │                   │
       └───────────────────┼───────────────────┘
                           ▼
┌────────────────────────────────────────────────┐
│  上级 Monitor                                   │
│                                                │
│  ┌──────────────────────────────────────────┐ │
│  │  1. 接收多个告警                          │ │
│  │     - Node-A: 数据库崩溃                  │ │
│  │     - Node-C: 磁盘故障                    │ │
│  └────────────┬─────────────────────────────┘ │
│               │                                │
│               ▼                                │
│  ┌──────────────────────────────────────────┐ │
│  │  2. 去重与关联分析                        │ │
│  │     - 检查是否为重复告警                  │ │
│  │     - 分析问题是否相关                    │ │
│  │       (例如：磁盘故障可能导致数据库崩溃)   │ │
│  └────────────┬─────────────────────────────┘ │
│               │                                │
│               ▼                                │
│  ┌──────────────────────────────────────────┐ │
│  │  3. 生成统一告警报告                      │ │
│  │     "检测到 2 个严重问题：                │ │
│  │      - Node-C 磁盘故障                    │ │
│  │      - Node-A 数据库崩溃 (可能相关)"      │ │
│  └────────────┬─────────────────────────────┘ │
│               │                                │
│               ▼                                │
│  ┌──────────────────────────────────────────┐ │
│  │  4. 通过 Telegram Bot 发送                │ │
│  └────────────┬─────────────────────────────┘ │
└───────────────┼────────────────────────────────┘
                │
                ▼
┌────────────────────────────────────┐
│  Telegram                          │
│                                    │
│  🚨 Cortex 集群告警                │
│                                    │
│  严重问题 (2个)：                  │
│  1. Node-C: 磁盘故障               │
│  2. Node-A: 数据库崩溃             │
│                                    │
│  可能的关联：磁盘故障导致数据库问题  │
│                                    │
│  请立即检查集群状态。              │
│  Web UI: https://monitor.example.com│
└────────────────────────────────────┘
```

## 6. 关键技术选型建议

### 6.1 后端技术栈

#### 6.1.1 编程语言
**推荐：Python 3.11+**

选择理由：
- Claude SDK 原生支持，开发效率高
- 丰富的运维工具库（psutil、paramiko 等）
- 异步编程支持良好（asyncio）
- 部署简单，跨平台兼容性好

#### 6.1.2 Web 框架
**推荐：FastAPI 0.104+**

选择理由：
- 原生异步支持，高性能
- 自动生成 OpenAPI 文档
- Pydantic 类型验证
- WebSocket 支持完善
- 开发体验优秀

#### 6.1.3 数据库
**推荐：SQLite 3.40+ + SQLAlchemy 2.0+**

选择理由：
- 零配置，易于部署
- 单文件存储，备份简单
- 支持 Intent-Engine 的 MCP 工具
- 性能足够（单节点场景）
- SQLAlchemy ORM 提供抽象层

**未来扩展**：若需要支持高并发或分布式场景，可迁移到 PostgreSQL。

#### 6.1.4 任务调度
**推荐：APScheduler 3.10+**

选择理由：
- Python 原生，无需外部依赖
- 灵活的 Cron 表达式支持
- 支持持久化（数据库后端）
- 易于集成到 FastAPI

#### 6.1.5 LLM SDK
**推荐：Anthropic Claude SDK 0.8+**

选择理由：
- 官方支持，稳定可靠
- 无头模式 (`claude -p`) 支持
- Tools (function calling) 支持完善
- 异步 API 支持

#### 6.1.6 其他关键依赖
```python
# requirements.txt 核心依赖示例
fastapi==0.104.1
uvicorn[standard]==0.24.0
sqlalchemy==2.0.23
pydantic==2.5.0
pydantic-settings==2.1.0
anthropic==0.8.1
apscheduler==3.10.4
httpx==0.25.2  # 异步 HTTP 客户端
psutil==5.9.6  # 系统监控
loguru==0.7.2  # 日志
python-telegram-bot==20.7  # Telegram Bot
alembic==1.13.0  # 数据库迁移
pytest==7.4.3  # 测试框架
pytest-asyncio==0.21.1  # 异步测试
```

### 6.2 前端技术栈

#### 6.2.1 核心框架
**推荐：React 18.2+ + TypeScript 5.0+**

选择理由：
- 生态成熟，组件库丰富
- TypeScript 提供类型安全
- 社区活跃，学习资源多
- Hooks 简化状态管理

#### 6.2.2 构建工具
**推荐：Vite 5.0+**

选择理由：
- 极快的开发服务器启动
- 热更新体验优秀
- 开箱即用的 TypeScript 支持
- 生产构建优化完善

#### 6.2.3 UI 组件库
**推荐：Ant Design 5.11+ 或 shadcn/ui**

选择理由（Ant Design）：
- 企业级组件库，适合管理后台
- 表格、表单组件强大
- 中文文档完善
- 主题定制能力强

选择理由（shadcn/ui）：
- 现代化设计风格
- 基于 Radix UI，可访问性好
- Tailwind CSS 集成
- 完全可定制

#### 6.2.4 状态管理
**推荐：Zustand 4.4+ + TanStack Query 5.0+**

选择理由：
- Zustand：轻量级全局状态管理
- TanStack Query：异步状态管理（API 请求）
- 两者配合，覆盖所有状态场景
- API 简洁，学习成本低

#### 6.2.5 数据可视化
**推荐：Recharts 2.10+ 或 Apache ECharts 5.4+**

选择理由（Recharts）：
- React 原生，组件化
- 声明式 API
- 适合简单图表场景

选择理由（ECharts）：
- 功能强大，图表类型丰富
- 性能优秀，支持大数据量
- 适合复杂可视化需求

#### 6.2.6 其他前端依赖
```json
// package.json 核心依赖示例
{
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.20.0",
    "axios": "^1.6.2",
    "socket.io-client": "^4.6.0",
    "zustand": "^4.4.7",
    "@tanstack/react-query": "^5.12.0",
    "antd": "^5.11.5",
    "recharts": "^2.10.3",
    "react-hook-form": "^7.48.2",
    "dayjs": "^1.11.10"
  },
  "devDependencies": {
    "typescript": "^5.3.3",
    "vite": "^5.0.7",
    "@vitejs/plugin-react": "^4.2.1",
    "tailwindcss": "^3.3.6",
    "eslint": "^8.55.0",
    "prettier": "^3.1.1"
  }
}
```

### 6.3 通信与存储

#### 6.3.1 API 通信
**推荐：RESTful API (HTTP/HTTPS)**

设计要点：
- 统一的响应格式
- 版本化 API 路径 (`/api/v1/...`)
- 标准 HTTP 状态码
- 请求/响应日志记录

#### 6.3.2 实时通信
**推荐：WebSocket (可选)**

使用场景：
- Web UI 实时数据更新
- 告警实时推送
- 节点状态实时刷新

实现方案：
- 后端：FastAPI WebSocket 支持
- 前端：socket.io-client

#### 6.3.3 告警通知
**推荐：Telegram Bot API**

选择理由：
- API 简单易用
- 支持 Markdown 格式
- 免费且稳定
- 支持群组通知

#### 6.3.4 配置管理
**推荐：YAML + Pydantic Settings**

配置文件示例：
```yaml
# config.yaml
agent:
  id: "node-001"
  name: "Production Server 1"
  mode: "cluster"  # standalone | cluster
  upstream_monitor_url: "https://monitor.example.com"

probe:
  schedule: "*/5 * * * *"  # 每 5 分钟
  timeout: 300  # 5 分钟超时

monitor:
  host: "0.0.0.0"
  port: 8000
  database_url: "sqlite:///./cortex.db"

telegram:
  bot_token: "${TELEGRAM_BOT_TOKEN}"  # 环境变量
  chat_id: "${TELEGRAM_CHAT_ID}"

claude:
  api_key: "${ANTHROPIC_API_KEY}"
  model: "claude-sonnet-4"
```

### 6.4 部署与运维

#### 6.4.1 容器化
**推荐：Docker + Docker Compose**

Dockerfile 结构：
```dockerfile
FROM python:3.11-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# 安装 Python 依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 暴露端口
EXPOSE 8000

# 启动命令
CMD ["uvicorn", "cortex.monitor:app", "--host", "0.0.0.0", "--port", "8000"]
```

Docker Compose 配置：
```yaml
version: '3.8'

services:
  cortex:
    build: .
    ports:
      - "8000:8000"
    volumes:
      - ./data:/app/data
      - ./.env:/app/config.yaml
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
    restart: unless-stopped
```

#### 6.4.2 进程管理
**推荐：systemd 或 supervisord**

systemd 服务示例：
```ini
[Unit]
Description=Cortex Monitor Service
After=network.target

[Service]
Type=simple
User=cortex
WorkingDirectory=/opt/cortex
ExecStart=/usr/local/bin/uvicorn cortex.monitor:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

#### 6.4.3 日志管理
**推荐：Python logging + loguru + 日志轮转**

日志配置示例：
```python
from loguru import logger

logger.add(
    "logs/cortex_{time:YYYY-MM-DD}.log",
    rotation="00:00",  # 每天轮转
    retention="30 days",  # 保留 30 天
    compression="zip",  # 压缩旧日志
    level="INFO"
)
```

#### 6.4.4 监控指标（可选）
**推荐：Prometheus client**

暴露指标示例：
```python
from prometheus_client import Counter, Histogram, generate_latest

# 定义指标
probe_executions = Counter('cortex_probe_executions_total', 'Total probe executions')
decision_requests = Counter('cortex_decision_requests_total', 'Total L2 decision requests')
api_request_duration = Histogram('cortex_api_request_duration_seconds', 'API request duration')

# FastAPI 路由
@app.get("/metrics")
async def metrics():
    return Response(generate_latest(), media_type="text/plain")
```

---

## 7. 总结

Cortex 系统架构的核心设计思想是：

1. **统一代码库，灵活部署**：同一份代码，通过配置实现独立模式或集群模式
2. **双核心模块**：Probe（执行）+ Monitor（决策），每个节点都是完整的智能体
3. **分级自治**：L1 本地修复，L2 需决策，L3 人类介入，清晰的权责边界
4. **意图可追溯**：所有操作通过 Intent-Engine 记录，确保完整审计轨迹
5. **动态层级**：支持多层嵌套集群，构建复杂的运维网络拓扑

技术选型以 **Python + FastAPI + React + SQLite** 为核心，追求简单、可靠、易部署的设计哲学。
